<div class="pxs-wf-root">
  @if (availableActions().length) {
    <div
      class="pxs-wf-palette"
      cdkDropList
      [cdkDropListSortingDisabled]="true"
      [cdkDropListConnectedTo]="[canvasList]"
      [cdkDropListData]="availableActions()"
    >
      <div class="pxs-wf-palette-title">Actions:</div>

      <div class="pxs-wf-palette-items" #paletteHost>
        @for (a of availableActions(); track a.type) {
          <button
            mat-stroked-button
            class="pxs-wf-pill"
            cdkDrag
            [cdkDragData]="a"
            [disabled]="disabled()"
            cdkDragRootElement=".pxs-wf-pill"
          >
            {{ a.type }}

            <ng-template cdkDragPreview>
              <div class="pxs-wf-pill preview">{{ a.type }}</div>
            </ng-template>
            <ng-template cdkDragPlaceholder>
              <div class="pxs-wf-pill placeholder"></div>
            </ng-template>
          </button>
        }
      </div>
    </div>
  }

  <div
    class="pxs-wf-canvas"
    #graphHost
    cdkDropList
    #canvasList="cdkDropList"
    [cdkDropListData]="{}"
    [cdkDropListEnterPredicate]="allowPaletteDrop"
    (cdkDropListDropped)="onDrop($event)"
    (mousemove)="onCanvasMouseMove($event)"
    (contextmenu)="openCanvasContextMenu($event)"
  >
    @if (ready() && canvasW() > 0 && canvasH() > 0) {
      <ngx-graph
        class="chart-container"
        [view]="[canvasW(), canvasH()]"
        [nodes]="gNodes()"
        [links]="gLinks()"
        [layout]="frozenLayout"
        [autoCenter]="false"
        [autoZoom]="false"
        [draggingEnabled]="!disabled()"
        [zoomSpeed]="0.075"
        [update$]="update$"
        (nodeSelected)="onNodeSelected($any($event))"
        (edgeSelected)="onEdgeSelected($any($event))"
        [curve]="curve"
      >
        <!-- defs (arrow heads) -->
        <ng-template #defsTemplate>
          <svg:marker
            id="arrow-solid"
            viewBox="0 -5 10 10"
            refX="8"
            refY="0"
            markerWidth="6"
            markerHeight="6"
            orient="auto"
          >
            <svg:path d="M0,-5L10,0L0,5" fill="currentColor"></svg:path>
          </svg:marker>
          <svg:marker
            id="arrow-hollow"
            viewBox="0 -5 10 10"
            refX="8"
            refY="0"
            markerWidth="6"
            markerHeight="6"
            orient="auto"
          >
            <svg:path
              d="M0,-5L10,0L0,5"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            ></svg:path>
          </svg:marker>
          <svg:marker
            id="arrow-round"
            viewBox="-5 -5 10 10"
            refX="0"
            refY="0"
            markerWidth="6"
            markerHeight="6"
            orient="auto"
          >
            <svg:circle r="3" fill="currentColor"></svg:circle>
          </svg:marker>
          <svg:marker
            id="arrow-warn"
            viewBox="0 -5 10 10"
            refX="8"
            refY="0"
            markerWidth="6"
            markerHeight="6"
            orient="auto"
          >
            <svg:path d="M0,5 L10,0 L0,-5 Z" fill="currentColor"></svg:path>
          </svg:marker>
        </ng-template>

        <!-- NODE (right-click + clickable ports) -->
        <ng-template #nodeTemplate let-node>
          <svg:g
            class="node"
            [ngClass]="node?.data?.type"
            [attr.data-node-id]="node.id"
            (contextmenu)="openNodeContextMenu(node.id, $event)"
          >
            <svg:rect
              rx="8"
              ry="8"
              [attr.width]="node.dimension?.width || 220"
              [attr.height]="
                node.dimension?.height ||
                60 +
                  ((node?.data?.ports?.inputs?.length || 0) +
                    (node?.data?.ports?.outputs?.length || 0)) *
                    4
              "
              [style.fill]="nodeFill(node?.data?.type)"
            />
            <!-- label -->
            <svg:text
              alignment-baseline="hanging"
              [attr.x]="12"
              [attr.y]="12"
              font-weight="600"
              [attr.fill]="'#000'"
            >
              {{ node.label }}
            </svg:text>

            <!-- INPUT PORTS (left) -->
            @if (node?.data?.ports?.inputs?.length) {
              @for (p of node.data.ports.inputs; track p.id; let i = $index) {
                <svg:g class="port port-in" (click)="clickPort(node.id, 'target', p.id, $event)">
                  <svg:circle
                    class="wf-handle target"
                    [attr.cx]="-8"
                    [attr.cy]="28 + i * 18"
                    r="6"
                  />
                  <svg:text
                    [attr.x]="4"
                    [attr.y]="32 + i * 18"
                    alignment-baseline="middle"
                    font-size="11"
                  >
                    {{ p.label }}
                  </svg:text>
                </svg:g>
              }
            }

            <!-- OUTPUT PORTS (right) -->
            @if (node?.data?.ports?.outputs?.length) {
              @for (p of node.data.ports.outputs; track p.id; let i = $index) {
                <svg:g
                  class="port port-out"
                  [class.pending]="isPending(node.id, p.id, 'source')"
                  (click)="clickPort(node.id, 'source', p.id, $event)"
                >
                  <svg:circle
                    class="wf-handle source"
                    [attr.cx]="(node.dimension?.width || 220) + 8"
                    [attr.cy]="28 + i * 18"
                    r="6"
                  />
                  <svg:text
                    [attr.x]="(node.dimension?.width || 220) - 4"
                    [attr.y]="32 + i * 18"
                    alignment-baseline="middle"
                    text-anchor="end"
                    font-size="11"
                  >
                    {{ p.label }}
                  </svg:text>
                </svg:g>
              }
            }
          </svg:g>
        </ng-template>

        <!-- LINK (right-clickable, label path fixed) -->
        <ng-template #linkTemplate let-link>
          <svg:g
            class="edge"
            [class.selected]="isEdgeSelected(link.id)"
            [attr.data-link-id]="link.id"
            (click)="selectEdge(link.id, $event)"
            (contextmenu)="openLinkContextMenu(link.id, $event)"
          >
            <svg:path
              [attr.id]="link.id"
              class="line"
              [attr.stroke]="link?.data?.style?.stroke || '#607d8b'"
              [attr.stroke-width]="
                isEdgeSelected(link.id)
                  ? (link?.data?.style?.strokeWidth || 2) + 1.5
                  : link?.data?.style?.strokeWidth || 2
              "
              [attr.stroke-dasharray]="link?.data?.style?.dasharray || null"
              [attr.marker-end]="'url(#arrow-' + (link?.data?.style?.marker || 'solid') + ')'"
            />
            <svg:text
              class="edge-label"
              text-anchor="middle"
              [attr.fill]="
                isEdgeSelected(link.id) ? '#000' : link?.data?.style?.labelColor || '#333'
              "
            >
              <svg:textPath class="text-path" [attr.href]="'#' + link.id" startOffset="50%">
                {{ link.label }}
              </svg:textPath>
            </svg:text>
          </svg:g>
        </ng-template>
      </ngx-graph>

      <!-- Ghost "rubber-band" preview -->
      @if (pending() && mouse(); as p) {
        <svg class="wf-overlay" [attr.width]="canvasW()" [attr.height]="canvasH()">
          <line
            [attr.x1]="ghostStart().x"
            [attr.y1]="ghostStart().y"
            [attr.x2]="mouse()!.x"
            [attr.y2]="mouse()!.y"
            class="wf-ghost-line"
          />
        </svg>
      }
    }
  </div>

  <!-- INSPECTOR (dialog-driven) -->
  <ng-template #inspectorTpl let-form="form" let-title="title">
    <h3 class="mb-2">{{ title }}</h3>
    <app-dynamic-form [config]="inspectorConfig" [form]="form"></app-dynamic-form>
  </ng-template>

  <ng-template #inspectorActionsTpl let-form="form">
    <button mat-button type="button" (click)="dialogCancel()">{{ 'cancel' | translate }}</button>
    <button
      mat-raised-button
      color="primary"
      type="button"
      [disabled]="form.invalid"
      (click)="dialogConfirm()"
    >
      {{ 'apply' | translate }}
    </button>
  </ng-template>

  @if (!disabled()) {
    <div class="pxs-help">
      <span>{{ 'tip' | translate }}</span> {{ 'workflow_help' | translate }}
    </div>
  }

  <!-- CONTEXT MENU -->
  @if (contextMenu(); as m) {
    <div class="pxs-menu" [style.left.px]="m.x" [style.top.px]="m.y">
      <button mat-button (click)="onConfigure()" [disabled]="m.type !== 'node'">
        {{ 'configure' | translate }}
      </button>
      <button mat-button (click)="onDelete()">{{ 'delete' | translate }}</button>
      <button mat-button (click)="closeContextMenu()">{{ 'close' | translate }}</button>
    </div>
  }
</div>
