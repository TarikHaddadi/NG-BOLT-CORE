# üìù Contributing Guide ‚Äì `@cadai/pxs-ng-core`
>_Last updated: 2025-08-21_

Welcome! This document explains how to work with the **PXS-NG-CORE** library: setup, development, versioning, and publishing to our private Azure Artifacts feed.

This document is the **source of truth** for how to work in this repository. It explains the folder structure, barrel usage, contribution workflow, and a pre‚Äëpush checklist to keep everything aligned.

---

## 1. üöÄ Prerequisites

- [Node.js LTS](https://nodejs.org/) (v18+ or v20+ recommended)  
- [Angular CLI](https://angular.dev/cli):  
  ```bash
  npm install -g @angular/cli
  ```
- A valid **Azure DevOps Personal Access Token (PAT)** with **Packaging: Read & Write** permissions.
---

## 2. üõ† Development

- Source code lives in `projects/core/`  
- Build output goes to `dist/core/`  

Build locally:
```bash
npm run build:core
```


### Core Layer

**Purpose:** framework-agnostic services, models, guards, interceptors, and the **single init point**.
> We use **barrel files** (`index.ts`) so consumers import from a single entry per layer. This keeps imports stable and avoids deep relative paths.

```text
projects/
‚îî‚îÄ core/
   ‚îú‚îÄ core/                           # Framework-agnostic building blocks
   ‚îú‚îÄ services/                    # Config, Http, Keycloak, Layout, Theme, Toast, User, etc.
   ‚îú‚îÄ directives/                  # Shared TS Directives
   ‚îú‚îÄ factories/                  # Shared TS Factories
   ‚îú‚îÄ interfaces/                  # Shared TS interfaces & models
   ‚îú‚îÄ enums/                       # Shared enums (e.g., UserRole)
   ‚îú‚îÄ utils/                       # Pure helpers & validators
   ‚îú‚îÄ guards/                      # Route guards (e.g., authGuard)
   ‚îú‚îÄ interceptors/                # Http interceptors (auth, error)
   ‚îÇ
   ‚îú‚îÄ shared/                         # Reusable UI + headless components
   ‚îÇ  ‚îú‚îÄ dialog/                      # Confirm dialogs, etc.
   ‚îÇ  ‚îú‚îÄ forms/                       # Form system & fields
   ‚îÇ  ‚îú‚îÄ fields/                      # Input, select, chips, autocomplete, etc.
   ‚îÇ  ‚îú‚îÄ dynamic-form-builder/        # Dynamic form engine/components
   ‚îÇ  ‚îú‚îÄ seo/                         # SEO component / meta service
   ‚îÇ  ‚îú‚îÄ layout/                      # AppLayoutComponent (standalone)
   ‚îÇ  ‚îú‚îÄ public-api.ts/             # barrels definition
   ‚îÇ  ‚îú‚îÄ index.ts/                  # exposes public-api
   ‚îÇ  ‚îî‚îÄ ng-package.json/           # used for building the Core SDK Module
   ‚îÇ
   ‚îú‚îÄ realtime/                       # Realtime CLients to use depending on the configuration
   ‚îÇ  ‚îú‚îÄ pushClient.ts/
   ‚îÇ  ‚îú‚îÄ SseClient.ts/
   ‚îÇ  ‚îú‚îÄ WebSocketClient.ts/
   ‚îÇ  ‚îú‚îÄ public-api.ts/             # barrels definition
   ‚îÇ  ‚îú‚îÄ index.ts/                  # exposes public-api
   ‚îÇ  ‚îî‚îÄ ng-package.json/           # used for building the Core SDK Module
   ‚îÇ
   ‚îî‚îÄ store/                          # NgRx (root + features)
   ‚îÇ   ‚îú‚îÄ features/
   ‚îÇ   ‚îÇ  ‚îú‚îÄ auth/ {actions,effects,reducer,selectors}/
   ‚îÇ   ‚îÇ  ‚îú‚îÄ team/ {actions,effects,reducer,selectors}/
   ‚îÇ   ‚îÇ  ‚îî‚îÄ user/ {actions,effects,reducer,selectors}/
   ‚îÇ   ‚îú‚îÄ app.actions.ts               # Global app actions (optional)
   ‚îÇ   ‚îú‚îÄ app.effects.ts               # Global effects (optional)
   ‚îÇ   ‚îú‚îÄ app.reducer.ts               # Root reducer map
   ‚îÇ   ‚îú‚îÄ app.selectors.ts             # Root selectors (optional)
   ‚îÇ   ‚îú‚îÄ app.state.ts                 # Root state
   ‚îÇ   ‚îî‚îÄ index.ts                     # Barrel: provideAppStore(), actions, selectors
   ‚îÇ
   ‚îú‚îÄ tokens/                       # App configurations
   ‚îÇ  ‚îú‚îÄ usertCtx/
   ‚îÇ  ‚îú‚îÄ public-api.ts/             # barrels definition
   ‚îÇ  ‚îú‚îÄ index.ts/                  # exposes public-api
   ‚îÇ  ‚îú‚îÄ ng-package.json/           # used for building the Core SDK Module
   ‚îÇ  ‚îî‚îÄ CoreOpts
   ‚îÇ
   ‚îú‚îÄ public-api.ts/             # barrels definition
   ‚îú‚îÄ index.ts/                  # exposes public-api
   ‚îî‚îÄ ng-package.json/           # used for building the Core SDK Module
   
```

### Path Aliases (tsconfig)

Make sure these exist so barrel imports work:

```jsonc
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@cadai/pxs-ng-core": ["projects/core/src/public-api.ts"],
      "@cadai/pxs-ng-core/*": ["projects/core/*/public-api.ts"]
    },
  }
}
```

### ESLint (Flat Config) Barrel Policy

- **Allowed deep alias imports**: `@cadai/pxs-ng-core/core`, `@cadai/pxs-ng-core/shared`, and so on (interfaces, interceptors, guards, enums, services, etc......)

(See `eslint.config.js` in repo for exact rules.)

### Example Imports

```ts
// Allowed deep @core/@shared
import {{ KeycloakService }} from '@cadai/pxs-ng-core/services';
import {{ AppLayoutComponent }} from '@cadai/pxs-ng-core/shared';
```

### Key Files

- `core/core.ts` ‚Äì registers HttpClient (interceptors), i18n, date providers, loads runtime config, initializes Keycloak, hydrates store.
- `services/keycloak.service.ts` ‚Äì PKCE, `login-required` (no auto-login in refresh loop), `ensureFreshToken`.
- `interceptors/auth.interceptor.ts` ‚Äì injects token, skips KC endpoints, only redirects to login on API `401`.
- `guards/auth.guard.ts` ‚Äì waits for Keycloak readiness and authorizes; with `login-required`, it does not call `login()`.

---

## 3. üì¶ Versioning

We follow **semantic versioning** (`MAJOR.MINOR.PATCH`):

- **Patch**: Bug fixes, no breaking changes ‚Üí `1.0.0 ‚Üí 1.0.1`
- **Minor**: Backward-compatible features ‚Üí `1.0.0 ‚Üí 1.1.0`
- **Major**: Breaking changes ‚Üí `1.0.0 ‚Üí 2.0.0`

Bump version inside `projects/core/package.json`:

```bash
npm run version:patch   # 1.0.0 ‚Üí 1.0.1
npm run version:minor   # 1.0.0 ‚Üí 1.1.0
npm run version:major   # 1.0.0 ‚Üí 2.0.0
```

---

## 4. üöÄ Publishing to Azure Artifacts

1. Build the library:
   ```bash
   npm run build:core
   ```

2. Publish:
   ```bash
   npm run publish:core
   ```

This will:
- Build with Angular CLI  
- Copy `.npmrc` into `dist/core`  
- Publish to the Azure feed  

---

## 5. Routing & Roles (on Host App)

```ts
// app.routes.ts
import {{ Routes }} from '@angular/router';
import {{ authGuard, UserRole }} from '@core';
import { AppLayoutComponent } from '@shared/layout/app-layout.component';

export const routes: Routes = [
  { path: '', redirectTo: '{customPath}', pathMatch: 'full' },
  {
    path: '',
    component: AppLayoutComponent,
    canActivateChild: [authGuard],
    children: [
      {
        path: '{customPath}',
        canActivate: [featureGuard('{customPath}', { forbid: '/403' })],
        data: { roles: [UserRole.ROLE_admin, UserRole.ROLE_user] },
        loadComponent: () =>
          import('./features/{customComponent}/{customComponent}.component').then(m => m.DashboardComponent),
      },
      { path: '403', loadComponent: () => import('@cadai/pxs-ng-core/shared').then(m => m.ForbiddenComponent) },
      { path: '**', loadComponent: () => import('@cadai/pxs-ng-core/shared').then(m => m.NotFoundComponent) },
    ]
  },
];
```

## 7. ‚ö° package.json Scripts

Available at the repo root:

```json
{
  "scripts": {
    "build:core": "ng build core",
    "version:patch": "npm version patch --prefix projects/core",
    "version:minor": "npm version minor --prefix projects/core",
    "version:major": "npm version major --prefix projects/core",
    "publish:core": "ng build core && copy .npmrc dist\\core\\.npmrc && cd dist/core && npm publish"
  }
}
```

---

## 8. ‚úÖ Checklist Before Publishing

- [ ] Run `npm run build:core` ‚Äì build passes with no errors  
- [ ] Update version with `npm run version:patch|minor|major`  
- [ ] Run `npm run publish:core`  
- [ ] Verify package is available on [Azure Artifacts feed](https://dev.azure.com/cadai/Socle/_packaging?_a=feed&feed=PXS-NG-CORE)  

###  Pre‚ÄëPush Checklist

- [ ] **Build passes**: `npm run build:core`
- [ ] **Lint passes**: `pnpm lint` (or `npm run lint`)
- [ ] **No deep relative imports** into `core/shared/features/store` (respect barrel policy)
- [ ] **Barrels updated**: new public APIs re‚Äëexported via `index.ts`
- [ ] **Store wired**: reducer registered, effects provided, selectors exported
- [ ] **i18n keys** added/updated
- [ ] **Types**: no `any`; strict mode friendly
- [ ] **Changelog/commit messages** follow Conventional Commits
- [ ] **Version bump** planned if releasing

---


## üßë‚Äçüíª Author

**Angular Product Skeleton**  
Built by **Tarik Haddadi** using Angular 19+and modern best practices (2025).