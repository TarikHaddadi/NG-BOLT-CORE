trigger:
  branches:
    include: [main, master, develop]
  paths:
    include:
      - projects/core/**
      - azure-pipelines.yml
      - package.json
      - package-lock.json
      - tsconfig*.json
      - projects/**

pr:
  branches:
    include: [main, master, develop]
  paths:
    include:
      - projects/core/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  PROJECT_DIR: 'projects/core'
  DIST_DIR: 'dist/core'

stages:
# ---------- Build & Test ----------
- stage: build_test
  displayName: Build & Test
  jobs:
  - job: build
    steps:
    - task: NodeTool@0
      inputs: { versionSpec: '$(NODE_VERSION)' }
      displayName: 'Use Node.js $(NODE_VERSION)'

    - script: npm ci
      displayName: 'Install dependencies'

    - script: npm run lint:ci
      displayName: 'Run ESLint (CI)'
      
    - script: npm run build:core
      displayName: 'Build library'

    - publish: $(DIST_DIR)
      artifact: pxs-ng-core
      displayName: 'Publish build artifact'
    
# ---------- Publish to Azure Artifacts ----------
- stage: publish
  displayName: Publish
  dependsOn: build_test
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  variables:
    FEED_URL: "https://pkgs.dev.azure.com/cadai/Socle/_packaging/PXS-NG-CORE/npm/registry/"
    # If your package is scoped like @cadai/core, set the scope to "cadai"
    NPM_SCOPE: "cadai"
  jobs:
    - job: publish_job
      displayName: Publish package to Azure Artifacts
      steps:
        - download: current
          artifact: pxs-ng-core

        - task: NodeTool@0
          inputs:
            versionSpec: '$(NODE_VERSION)'
          displayName: 'Use Node.js $(NODE_VERSION)'

        # Create an .npmrc in the artifact directory and authenticate it
        - script: |
            set -euo pipefail
            PKG_DIR="$(Pipeline.Workspace)/pxs-ng-core"
            echo "@$(NPM_SCOPE):registry=$(FEED_URL)" > "$PKG_DIR/.npmrc"
            echo "always-auth=true" >> "$PKG_DIR/.npmrc"
          displayName: 'Create .npmrc in artifact directory'

        - task: NpmAuthenticate@0
          displayName: 'Authenticate .npmrc for Azure Artifacts'
          inputs:
            # IMPORTANT: point to the file you just created (a file, not a folder)
            workingFile: '$(Pipeline.Workspace)/pxs-ng-core/.npmrc'

        # (Optional) Remove this; printing tokens is risky
        # - script: cat $(Pipeline.Workspace)/pxs-ng-core/.npmrc
        #   displayName: 'Show .npmrc (debug)'

        - script: |
            set -euo pipefail
            PKG_DIR="$(Pipeline.Workspace)/pxs-ng-core"
            PKG_JSON="$PKG_DIR/package.json"
            test -f "$PKG_JSON" || { echo "package.json not found in $PKG_DIR"; exit 1; }

            export PKG_JSON

            PKG_NAME=$(node -e "console.log(require(process.env.PKG_JSON).name)")
            PKG_VER=$(node -e "console.log(require(process.env.PKG_JSON).version)")

            echo "Publishing ${PKG_NAME}@${PKG_VER}"

            cd "$PKG_DIR"

            # ensure npm commands use the authenticated .npmrc
            npm whoami || echo "Authenticated (whoami may not print user on Azure Artifacts)."

            # Check if version already exists on the Azure Artifacts feed (use the feed registry!)
            if npm view "${PKG_NAME}@${PKG_VER}" version --registry "$(FEED_URL)" >/dev/null 2>&1; then
              echo "Version already exists on the feed. Skipping publish."
              exit 0
            fi

            # Safer to ignore lifecycle scripts in CI publishing
            npm config set ignore-scripts true
            npm publish --ignore-scripts --registry "$(FEED_URL)"
          displayName: 'Publish to Azure Artifacts'
          env:
            FEED_URL: $(FEED_URL)


# ---------- Tag on Main ----------
- stage: tag_on_main
  displayName: "Create git tag from package version"
  dependsOn: 
    - build_test
    - publish
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
    - job: tag_job
      displayName: "Tag repo with v<version>"
      steps:
        - checkout: self
          persistCredentials: true

        - task: NodeTool@0
          inputs:
            versionSpec: '20.x'
          displayName: 'Use Node.js'

        - script: |
            set -euo pipefail

            # Use the System.AccessToken for git HTTPS ops
            git config --global http.https://dev.azure.com/.extraheader "AUTHORIZATION: bearer $(System.AccessToken)"
            git config --global user.email "build-bot@ci"
            git config --global user.name  "Build Bot"
            git config --global safe.directory $(Build.SourcesDirectory)

            PKG_PATH="projects/core/package.json"
            VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
            TAG="PXS-NG-CORE@$VERSION"

            echo "Detected version: $VERSION"
            echo "Proposed tag:    $TAG"

            # Make sure we have latest tags from origin
            git fetch --tags --force

            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists. Nothing to do."
              exit 0
            fi

            git tag -a "$TAG" -m "release: $TAG"
            git push origin "$TAG"
            echo "Created and pushed tag $TAG"
          displayName: 'Create & push tag from package version'
          env:
            PKG_PATH: projects/core/package.json
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)  # exposed to the script
        